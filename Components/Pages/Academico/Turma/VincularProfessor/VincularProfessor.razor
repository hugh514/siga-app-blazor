@page "/turmas/vincular_professor"
@using SigaApp.Models.Turma
@using SigaApp.Models.Professor
@using SigaApp.Models
@inject TurmaDAO turmaDAO
@inject ProfessorDAO professorDAO
@inject ProfessorTurmaDAO professorTurmaDAO

@rendermode InteractiveServer

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Vincular Professor</h2>   
</div>

@if (turmaSelecionada == null)
{
    <div class="alert alert-warning d-flex align-items-center mb-3">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Nenhuma turma selecionada!
    </div>
}

<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form class="row g-2 align-items-end" @onsubmit="Filtrar">
            <!-- Período letivo -->
            <div class="col-md-3">
                <label class="form-label">Período Letivo</label>
                <select class="form-select" @bind="filtroPeriodoLetivo">
                    <option value="todos">Todos os períodos</option>
                    @foreach (var periodo in listaPeriodoLetivo)
                    {
                        <option value="@periodo">@periodo</option>
                    }
                </select>
            </div>

            <!-- Ano/Série -->
            <div class="col-md-4">
                <label class="form-label">Ano / Série</label>
                <select class="form-select"
                        @bind="filtroAno"
                        disabled="@(string.IsNullOrWhiteSpace(filtroPeriodoLetivo))">
                    <option value="todos">Todas as séries</option>
                    <option value="1° ano">1º Ano</option>
                    <option value="2° ano">2º Ano</option>
                    <option value="3° ano">3º Ano</option>
                    <option value="4° ano">4º Ano</option>
                    <option value="5° ano">5º Ano</option>
                </select>
            </div>

            <!-- Turma -->
            <div class="col-md-5">
                <label class="form-label">Turma</label>
                <select class="form-select"
                        @bind="turmaSelecionadaId"
                        disabled="@(string.IsNullOrWhiteSpace(filtroAno))">
                    <option value="">Selecione a Turma</option>
                    @foreach (var t in listaTurmaFiltrada)
                    {
                        <option value="@t.Id">@($"{t.Ano} {t.Nome} {t.Turno} - {t.PeriodoLetivo}")</option>
                    }
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Resultado da filtragem / seleção de turma e professores -->
@if (listaProfessorExibida.Any())
{
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <strong>Turma selecionada: </strong>
                    @if (turmaSelecionada != null)
                    {
                        <span>@($"{turmaSelecionada.Ano} {turmaSelecionada.Nome} {turmaSelecionada.Turno} - {turmaSelecionada.PeriodoLetivo}")</span>
                    }
                    else
                    {
                        <span class="text-muted">Nenhuma</span>
                    }
                </div>
                <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           id="mostrarInativos"
                           @bind="mostrarInativos" />

                    <label class="form-check-label" for="mostrarInativos">
                        Mostrar professores inativos
                    </label>
                </div>
            </div>

            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Disciplina</th>
                        <th style="width:160px">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var prof in listaProfessorExibida)
                    {
                        var isSelected = professoresSelecionados.Contains(prof.Id);
                        var isAlreadyLinked = vinculosAtuais.Contains(prof.Id);
                        string rowStyle = isSelected ? "background-color:#f3f6f9;" : "";

                        <tr style="@rowStyle; cursor:pointer" @onclick="() => ToggleSelecionarProfessor(prof.Id)">
                            <td>
                                @prof.Nome
                                @if (isSelected)
                                {
                                    <span class="badge bg-secondary ms-2">Selecionado</span>
                                }
                                @if (isAlreadyLinked)
                                {
                                    <span class="badge bg-light text-dark border ms-2" title="Já vinculado">Vinculado</span>
                                }
                            </td>
                            <td>@prof.Disciplina</td>
                            <td>
                                <small class="text-muted">@prof.Status</small>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">@($"{professoresSelecionados.Count} professor(es) selecionado(s)")</small>
                </div>
                <div>
                    <button class="btn btn-outline-success me-2" @onclick="VincularProfessores" disabled="@(turmaSelecionada == null || !professoresSelecionados.Any())">Vincular selecionados</button>
                    <button class="btn btn-outline-danger me-2" @onclick="DesvincularProfessores"disabled="@(turmaSelecionada == null || !professoresSelecionados.Any())">Desvincular selecionados</button>
                    <button class="btn btn-outline-warning" @onclick="LimparSelecao" disabled="@( !professoresSelecionados.Any())">Limpar seleção</button>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <p class="text-muted">Nenhum professor encontrado. Faça o filtro para visualizar resultados.</p>
}

@code {
    // filtros
    private string _filtroAno = "todos";
    private string filtroAno
    {
        get => _filtroAno;
        set
        {
            _filtroAno = value;
            turmaSelecionadaId = null;
            CarregarTurmasFiltradas();
        }
    }

    private string _filtroPeriodoLetivo = "todos";
    private string filtroPeriodoLetivo
    {
        get => _filtroPeriodoLetivo;
        set
        {
            _filtroPeriodoLetivo = value;
            CarregarTurmasFiltradas();
        }
    }

    // turmas e professores
    private List<Turma> listaTurmaFiltrada = new();
    private List<Professor> listaProfessor = new();
    private List<Professor> listaProfessorExibida => listaProfessor
        .Where(p => mostrarInativos ? true : p.Status?.ToLower() == "ativo")
        .ToList();

    private List<string> listaPeriodoLetivo = new();

    // seleção
    private int? _turmaSelecionadaId;
    private int? turmaSelecionadaId
    {
        get => _turmaSelecionadaId;
        set
        {             
            _turmaSelecionadaId = value;
            CarregarTurmasFiltradas();
            OnTurmaChanged();
            if(_turmaSelecionadaId == null)
            {
                turmaSelecionada = null;
                return;
            }

        }
    }

    private Turma? turmaSelecionada;
    private HashSet<int> professoresSelecionados = new();
    private HashSet<int> vinculosAtuais = new(); // ids de professores já vinculados à turma selecionada

    // toggle mostrar inativos
    private bool mostrarInativos = false;

    protected override void OnInitialized()
    {
        // carregar períodos disponíveis (exemplo: pegar distinct PeriodoLetivo das turmas)
        // supondo que turmaDAO possua um método para retornar períodos distintos
        try
        {
            listaPeriodoLetivo = turmaDAO.ListarTodos().Select(t => t.PeriodoLetivo.ToString())
            .Distinct()
            .ToList();

            //aplica o filtro desde o inicio
            CarregarTurmasFiltradas();
        }
        catch
        {
            // fallback caso o método não exista
            var todas = turmaDAO.ListarTodos();
            listaPeriodoLetivo = todas.Select(t => t.PeriodoLetivo).Distinct().OrderBy(x => x).ToList();
        }

        // carregar todos professores (filtragem de status será aplicada dinamicamente)
        listaProfessor = professorDAO.ListarTodos();
    }

    private void Filtrar()
    {
        // método chamado no submit, reusa a mesma lógica de carregamento das turmas filtradas
        CarregarTurmasFiltradas();
    }




    // metodo que aplica o filtro
    private void CarregarTurmasFiltradas()
    {
        listaTurmaFiltrada.Clear();
        turmaSelecionada = null;

        var todas = turmaDAO.ListarTodos();

        // inicia com todas
        var query = todas.AsEnumerable();

        // se período foi selecionado e não é "todos", filtra
        if (!string.IsNullOrWhiteSpace(filtroPeriodoLetivo) &&
            filtroPeriodoLetivo.ToLower() != "todos")
        {
            query = query.Where(t =>
                t.PeriodoLetivo.Equals(filtroPeriodoLetivo, StringComparison.OrdinalIgnoreCase));
        }

        // se ano foi selecionado e não é "todos", filtra
        if (!string.IsNullOrWhiteSpace(filtroAno) &&
            filtroAno.ToLower() != "todos")
        {
            query = query.Where(t =>
                t.Ano.Equals(filtroAno, StringComparison.OrdinalIgnoreCase));
        }

        listaTurmaFiltrada = query.OrderBy(t => t.Nome).ToList();

        // atualizar turma selecionada se ainda existir na lista filtrada
        if (turmaSelecionadaId.HasValue && turmaSelecionadaId.Value != 0)
        {
            turmaSelecionada = listaTurmaFiltrada
                .FirstOrDefault(t => t.Id == turmaSelecionadaId.Value);
        }
    }

    //faz o carregamento dos professores já vinculados com a turma selecionada
    private void OnTurmaChanged()
    {
        professoresSelecionados.Clear();
        vinculosAtuais.Clear();


        if (turmaSelecionadaId.HasValue)
        {
            // carregar vínculos atuais para essa turma (ids de professores já vinculados)
            var vinculos = professorTurmaDAO.ListarPorTurma(turmaSelecionadaId ?? 0);

           
            vinculosAtuais = vinculos.Select(v => v.Id_Professor_fk ?? 0).ToHashSet();
            // opcional: pré-marcar os vinculados como selecionados? (não foi solicitado, por isso não pré-marcamos)
        }
        else
        {
            turmaSelecionada = null;
        }
    }

    //metodo que lota a lista de professores selecionados
    private void ToggleSelecionarProfessor(int professorId)
    {
        if (professoresSelecionados.Contains(professorId))
            professoresSelecionados.Remove(professorId);
        else
            professoresSelecionados.Add(professorId);
    }

    //limpa a lista de professores selecionados
    private void LimparSelecao()
    {
        professoresSelecionados.Clear();
    }


    //vincula professor com a turma
    private void VincularProfessores()
    {
        if (turmaSelecionada == null || !professoresSelecionados.Any())
            return;

        // Filtra professores que ainda NAO estavam vinculados
        var novos = professoresSelecionados.Where(id => !vinculosAtuais.Contains(id)).ToList();
        if (!novos.Any())
            return;

        // INSERE VÍNCULOS NO BANCO
        foreach (var idProf in novos)
        {
            var vinculo = new ProfessorTurma
            {
                Id_Professor_fk = idProf,
                Id_Turma_fk = turmaSelecionada.Id
            };

            professorTurmaDAO.Inserir(vinculo);
        }

        // Atualizar lista de vínculos locais (UI)
        foreach (var id in novos)
            vinculosAtuais.Add(id);

        // Limpa seleção após vincular
        foreach (var id in novos)
            professoresSelecionados.Remove(id);
    }

    private void DesvincularProfessores()
    {
        if (turmaSelecionada == null || !professoresSelecionados.Any())
            return;

        // Professores que realmente ESTÃO vinculados
        var paraRemover = professoresSelecionados
            .Where(id => vinculosAtuais.Contains(id))
            .ToList();

        if (!paraRemover.Any())
            return;

        foreach (var idProf in paraRemover)
        {
            professorTurmaDAO.Excluir(idProf, turmaSelecionada.Id);
            vinculosAtuais.Remove(idProf);
        }

        // limpa seleção após remover
        foreach (var id in paraRemover)
            professoresSelecionados.Remove(id);
    }

}
