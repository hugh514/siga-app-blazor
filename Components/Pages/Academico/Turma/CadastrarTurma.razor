@page "/turmas/cadastrar_turma"
@rendermode InteractiveServer

@using SigaApp.ViewModels
@using SigaApp.Models
@using SigaApp.Models.Turma
@inject NavigationManager Navigation
@inject TurmaDAO turmaDAO

<PageTitle>Cadastrar Turma</PageTitle>

<h2 class="fw-bold mb-4">Cadastro de Turma</h2>

<EditForm Model="_novaTurma" OnValidSubmit="Salvar">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row g-3">

        <!-- Nome da Turma -->
        <div class="col-md-6">
            <label class="form-label">Nome da Turma</label>
            <InputText @bind-Value="_novaTurma.Nome" class="form-control" />
            <ValidationMessage For="@(() => _novaTurma.Nome)" />
        </div>

        <!-- Ano/Série -->
        <div class="col-md-3">
            <label class="form-label">Ano/Série</label>
            <InputSelect @bind-Value="_novaTurma.Ano" class="form-select">
                <option value="">Selecione...</option>
                <option value="1° ano">1º Ano</option>
                <option value="2° ano">2º Ano</option>
                <option value="3° ano">3º Ano</option>
                <option value="4° ano">4º Ano</option>
                <option value="5° ano">5º Ano</option>
            </InputSelect>
            <ValidationMessage For="@(() => _novaTurma.Ano)" />
        </div>

        <!-- Turno -->
        <div class="col-md-3">
            <label class="form-label">Turno</label>
            <InputSelect @bind-Value="_novaTurma.Turno" class="form-select">
                <option value="">Selecione...</option>
                <option value="matutino">Matutino</option>
                <option value="vespertino">Vespertino</option>                
            </InputSelect>
            <ValidationMessage For="@(() => _novaTurma.Turno)" />
        </div>

        <!-- Período Letivo -->
        <div class="col-md-3">
            <label class="form-label">Período Letivo</label>
            <InputText @bind-Value="_novaTurma.PeriodoLetivo" class="form-control" placeholder="Ex: 2025" />
        </div>

        <!-- Capacidade Máxima -->
        <div class="col-md-3">
            <label class="form-label">Capacidade Máxima</label>
            <InputNumber @bind-Value="_novaTurma.Capacidade" class="form-control" min="1" />
            <ValidationMessage For="@(() => _novaTurma.Capacidade)" />
        </div>
    </div>

    <div class="mt-4 d-flex justify-content-end gap-2">
        <a href="/turmas" class="btn btn-outline-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Salvar</button>
    </div>
</EditForm>

@if (!string.IsNullOrEmpty(erro))
{
    <div class="alert alert-danger mt-3">@erro</div>
}

@code {
    private string? erro;
    private TurmaViewModel _novaTurma = new();

    protected override void OnInitialized()
    {
        _novaTurma.PeriodoLetivo = DateTime.Now.Year.ToString();
    }

    private void Salvar()
    {
        try
        {
            var turma = new Turma
            {
                Nome = _novaTurma.Nome,
                Ano = _novaTurma.Ano,
                PeriodoLetivo = _novaTurma.PeriodoLetivo,
                Turno = _novaTurma.Turno,
                Capacidade = _novaTurma.Capacidade,
                Status = "ativo"
            };

            turmaDAO.Inserir(turma);

            Navigation.NavigateTo("/turmas");
        }
        catch (Exception ex)
        {
            erro = "Erro ao salvar: " + ex.Message;
        }
    }
}
