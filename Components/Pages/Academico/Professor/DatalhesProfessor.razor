@page "/professores/detalhes_professor/{Id:int}"
@page "/turmas/detalhes_turma/{Id_Tur:int}/detalhes_professor/{Id:int}"

@using SigaApp.Models.Professor
@using SigaApp.Models.Turma
@using SigaApp.Models
@inject ProfessorDAO professorDAO
@inject ProfessorTurmaDAO professorTurmaDAO
@inject TurmaDAO turmaDAO
@inject NavigationManager NavManager

@rendermode InteractiveServer

<PageTitle>Detalhes Professor</PageTitle>

<div class="container py-4">
    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="height:200px;">
            <div class="spinner-border" role="status"></div>
        </div>
    }
    else
    {
        <div class="row g-4">
            <!-- Card com informações do professor -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body d-flex gap-4 align-items-center">

                        <!-- Foto -->
                        <img src="https://i.pravatar.cc/200?u=@(professor.Id)"
                             alt="Foto do professor"
                             class="rounded-circle border"
                             style="width:140px;height:140px;object-fit:cover;">

                        <div class="flex-fill">

                            <!-- Cabeçalho -->
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h3 class="mb-1">@professor.Nome</h3>

                                    <!-- Diciplina-->
                                    <div class="text-muted small">
                                        @(professor.Disciplina == "ed fisica" ? "Ed. Fisica" : "Ensino Fundamental")
                                </div>
                            </div>

                                <div class="text-end">
                                    <span class="badge @( (professor.Status ?? "ativo").ToLower() == "ativo" ? "bg-success" : "bg-secondary") fs-6">
                                        @( (professor.Status ?? "ativo").ToUpper() )
                                    </span>
                                </div>
                            </div>

                            <!-- Detalhes -->
                            <div class="mt-3 row">                              

                                <div class="col-md-4 mb-2">
                                    <strong>CPF:</strong>
                                    <div class="text-muted">@professor.Cpf</div>
                                </div>

                                <div class="col-md-4 mb-2">
                                    <strong>Telefone:</strong>
                                    <div class="text-muted">@professor.Telefone</div>
                                </div>

                                <div class="col-md-4 mb-2">
                                    <strong>E-mail:</strong>
                                    <div class="text-muted">@professor.Email</div>
                                </div>

                                <div class="col-md-4 mb-2">
                                    <strong>Disciplina:</strong>
                                    <div class="text-muted">@professor.Disciplina</div>
                                </div>

                                <div class="col-md-4 mb-2">
                                    <strong>Especialidade:</strong>
                                    <div class="text-muted">@professor.Especialidade</div>
                                </div>

                                <div class="col-md-4 mb-2">
                                    <strong>Data de Cadastro:</strong>
                                    <div class="text-muted">
                                        @professor.DataCadastro.ToString("dd/MM/yyyy")
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>


            <!-- Lista de turmas vinculadas -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="mb-0">Turmas vinculadas</h5>
                                <small class="text-muted">Lista de turmas associadas a este professor</small>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mostrarInativos" @bind="mostrarInativos"/>
                                <label class="form-check-label" for="mostrarInativos">Mostrar turmas inativas</label>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Turma</th>
                                        <th>Ano</th>
                                        <th>Turno</th>
                                        <th style="width:140px">Status</th>
                                        <th class="text-center" style="width:220px">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (vinculos == null)
                                    {
                                        <tr>
                                            <td colspan="5" class="text-center py-4">
                                                <div class="spinner-border"></div>
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        var exibidas = GetTurmasFiltradas();
                                        if (!exibidas.Any())
                                        {
                                            <tr>
                                                <td colspan="5" class="text-center py-4 text-muted">
                                                    Nenhuma turma encontrada.
                                                </td>
                                            </tr>
                                        }
                                        else
                                        {
                                            @foreach (var v in exibidas)
                                            {
                                                <tr>
                                                    <td>@(v.Turma?.Nome ?? "—")</td>
                                                    <td>@(v.Turma?.Ano ?? "—")</td>
                                                    <td>@(v.Turma?.Turno ?? "—")</td>
                                                    <td>
                                                        @if ((v.Turma?.Status ?? "ativo").ToLower() == "ativo")
                                                        {
                                                            <span class="badge bg-success">Ativa</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">Inativa</span>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        <a class="btn btn-outline-primary btn-sm me-2"
                                                           href="/professores/detalhes_professor/@professor.Id/detalhes_turma/@v.Turma?.Id">
                                                            Ver turma
                                                        </a>

                                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => DesvincularVinculo(v.Vinculo.Id)">
                                                            Desvincular
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }
    [Parameter]
    public int Id_Tur { get; set; }

    // Modelo de exibição: junta o vínculo com a turma carregada
    private class VinculoExibicao
    {
        public ProfessorTurma Vinculo { get; set; }
        public Turma Turma { get; set; }
    }

    private Professor professor = new();
    private List<ProfessorTurma> vinculos = null;
    private List<VinculoExibicao> vinculosComTurma = new();
    private bool _mostrarInativos = false;
    private bool mostrarInativos
    {
        get => _mostrarInativos;
        set
        {
            _mostrarInativos = value;
            OnFiltroChanged();
        }
    }
    private bool isLoading = true;

    protected override void OnInitialized()
    {
        CarregarDados();
    }

    private void CarregarDados()
    {
        isLoading = true;

        // Carrega professor
        professor = professorDAO.BuscarPorId(Id) ?? new Professor();

        // Carrega vínculos do professor
        vinculos = professorTurmaDAO.ListarPorProfessor(Id) ?? new List<ProfessorTurma>();

        // Para cada vínculo, busca a turma (se houver)
        vinculosComTurma = new List<VinculoExibicao>();
        foreach (var v in vinculos)
        {
            Turma turma = null;
            if (v.Id_Turma_fk != null)
            {
                try
                {
                    turma = turmaDAO.BuscarPorId(v.Id_Turma_fk.Value);
                }
                catch
                {
                    // se falhar ao buscar turma, ignoramos (turma ficará null)
                    turma = null;
                }
            }

            vinculosComTurma.Add(new VinculoExibicao
            {
                Vinculo = v,
                Turma = turma
            });
        }

        isLoading = false;
        StateHasChanged();
    }

    // Retorna somente as turmas que devem ser exibidas conforme filtro:
    // - por padrão só exibe turmas com Status == "ativo"
    // - se mostrarInativos == true exibe todas (inclui inativas)
    private IEnumerable<VinculoExibicao> GetTurmasFiltradas()
    {
        if (vinculosComTurma == null) return Enumerable.Empty<VinculoExibicao>();

        if (mostrarInativos)
        {
            // mostrar todas (inclui nulas)
            return vinculosComTurma;
        }

        // somente ativas — caso turma == null, consideramos "mostrar" (ou você pode ocultar)
        return vinculosComTurma.Where(x => x.Turma != null && (x.Turma.Status ?? "ativo").ToLower() == "ativo");
    }

    private void OnFiltroChanged()
    {
        // o bind já atualizou mostrarInativos; apenas forçamos re-render
        StateHasChanged();
    }

    private void DesvincularVinculo(int id_ptu)
    {
        if (id_ptu <= 0) return;

        try
        {
            // Assumo método Excluir em professorTurmaDAO. Ajuste se necessário.
            professorTurmaDAO.Excluir(professor.Id, id_ptu);

            // Recarrega a lista após exclusão
            CarregarDados();
        }
        catch (Exception ex)
        {
            // Aqui você pode tratar/mostrar erro (toast, modal, etc).
            Console.WriteLine("Erro ao desvincular: " + ex.Message);
        }
    }
}
