@inject NavigationManager NavigationManager
@implements IDisposable

<nav aria-label="breadcrumb" class="mb-3 breadcrumb-container">
    <ol class="breadcrumb custom-breadcrumb">
        @foreach (var item in BreadcrumbItems)
        {
            if (item.IsActive)
            {
                <li class="breadcrumb-item active" aria-current="page">@item.Title</li>
            }
            else
            {
                <li class="breadcrumb-item">
                    <a href="@item.Url" class="breadcrumb-link">@item.Title</a>
                </li>
            }
        }
    </ol>
</nav>

@code {
    private List<BreadcrumbItem> BreadcrumbItems = new();

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        BuildBreadcrumb();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        BuildBreadcrumb();
        StateHasChanged();
    }

    private void BuildBreadcrumb()
    {
        BreadcrumbItems.Clear();

        var fullPath = NavigationManager.Uri
            .Replace(NavigationManager.BaseUri, "")
            .Trim('/');

        var segments = fullPath.Split('/', StringSplitOptions.RemoveEmptyEntries);

        string currentPath = NavigationManager.BaseUri;
        string? lastNumeric = null;

        for (int i = 0; i < segments.Length; i++)
        {
            string segment = segments[i];
            bool isNumeric = int.TryParse(segment, out _);
            bool isLast = (i == segments.Length - 1);

            if (isNumeric)
            {
                lastNumeric = segment; // salva o ID para link anterior
                currentPath += segment + "/";
                continue; // não exibe número no breadcrumb
            }

            // título bonitinho
            string title = Capitalize(segment.Replace("_", " "));

            // Se o próximo segmento for um ID, adicionamos ao link
            string finalPath = currentPath + segment + "/";

            if (i + 1 < segments.Length && int.TryParse(segments[i + 1], out _))
            {
                finalPath += segments[i + 1] + "/";
            }

            // Descobrindo se este item representa realmente a página atual
            // Identifica se os próximos segmentos são ONLY IDs
            bool nextSegmentsAreOnlyIds = true;

            for (int j = i + 1; j < segments.Length; j++)
            {
                if (!int.TryParse(segments[j], out _))
                {
                    nextSegmentsAreOnlyIds = false;
                    break;
                }
            }

            // A regra: página atual = último segmento textual antes dos IDs
            bool isCurrentPage = nextSegmentsAreOnlyIds;

            BreadcrumbItems.Add(new BreadcrumbItem(
                Title: title,
                Url: isCurrentPage ? "#" : finalPath,
                IsActive: isCurrentPage
            ));

            currentPath = finalPath;
        }
    }

    private string Capitalize(string text)
    {
        if (string.IsNullOrEmpty(text)) return text;

        var clean = text.Replace("_", " ");
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(clean);
    }

    private record BreadcrumbItem(string Title, string Url, bool IsActive = false);

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
